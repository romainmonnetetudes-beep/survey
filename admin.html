<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Editeur de sondage</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    h1 { color: #1a5276; }
    .login-box { background: white; padding: 30px; border-radius: 10px; max-width: 300px; margin: 100px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input[type=password], input[type=text], select, textarea { width: 100%; padding: 8px; margin: 6px 0 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    button { padding: 10px 20px; background: #1a5276; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 4px; }
    button:hover { background: #154360; }
    button.danger { background: #c0392b; }
    button.success { background: #27ae60; }
    .section { background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.07); }
    .section h2 { margin-top: 0; color: #1a5276; font-size: 1.1em; }
    .question-block { border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 10px; background: #fafafa; }
    .option-row { display: flex; gap: 6px; margin-bottom: 6px; align-items: center; }
    .option-row input { margin: 0; }
    .msg { padding: 12px; border-radius: 6px; margin-bottom: 15px; display: none; }
    .msg.success { background: #d4edda; color: #155724; }
    .msg.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>

  <a href="/" style="
  position: fixed;
  top: 16px;
  left: 16px;
  background: white;
  color: #0f2540;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85em;
  font-weight: 500;
  padding: 8px 16px;
  border-radius: 20px;
  text-decoration: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.12);
  z-index: 1000;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)'"
   onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 10px rgba(0,0,0,0.12)'">
  ‚Üê Accueil
</a>

<div id="login-screen" class="login-box">
  <h2 style="color:#1a5276;margin-top:0">Acces admin</h2>
  <label>Mot de passe :</label>
  <input type="password" id="password">
  <button onclick="login()" style="width:100%;margin-top:8px">Connexion</button>
  <p id="login-error" style="color:red;display:none;margin-top:10px">Mot de passe incorrect.</p>
</div>
<div id="editor" style="display:none">
  <h1>Editeur de sondage</h1>
  <div id="msg" class="msg"></div>
  <div id="sections-container"></div>
  <button class="success" onclick="addSection()">+ Ajouter une section</button>
  <button onclick="saveQuestions()" style="background:#1a5276;font-size:1.1em;padding:12px 30px;margin-top:20px;display:block;width:100%">Sauvegarder</button>
</div>
<script>
var ADMIN_PASSWORD = "millau2026";
var questionsData = null;

function login() {
  var pw = document.getElementById("password").value;
  if (pw === ADMIN_PASSWORD) {
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("editor").style.display = "block";
    loadQuestions();
  } else {
    document.getElementById("login-error").style.display = "block";
  }
}

function loadQuestions() {
  fetch("/questions").then(function(r) { return r.json(); }).then(function(data) {
    questionsData = data;
    renderEditor();
  });
}

function renderEditor() {
  var container = document.getElementById("sections-container");
  container.innerHTML = "";
  questionsData.sections.forEach(function(section, si) {
    var div = document.createElement("div");
    div.className = "section";
    div.innerHTML = "<div style='display:flex;justify-content:space-between;align-items:center'><h2>Section " + (si+1) + ": " + section.title + "</h2><button class='danger' onclick='removeSection(" + si + ")'>Supprimer</button></div><label>Titre:</label><input type='text' value='" + section.title.replace(/'/g,"") + "' onchange='questionsData.sections[" + si + "].title=this.value'><div id='questions-" + si + "'></div><button class='success' style='font-size:0.85em;padding:6px 12px' onclick='addQuestion(" + si + ")'>+ Ajouter une question</button>";
    container.appendChild(div);
    renderQuestions(si);
  });
}

function renderQuestions(si) {
  var container = document.getElementById("questions-" + si);
  container.innerHTML = "";
  questionsData.sections[si].questions.forEach(function(q, qi) {
    var div = document.createElement("div");
    div.className = "question-block";
    var optHTML = "";
    if (q.type === "radio" || q.type === "checkbox" || q.type === "select") {
      var opts = (q.options || []).map(function(opt, oi) {
        return "<div class='option-row'><input type='text' value='" + opt.replace(/'/g,"") + "' onchange='questionsData.sections[" + si + "].questions[" + qi + "].options[" + oi + "]=this.value' style='flex:1'><button class='danger' style='padding:4px 8px' onclick='removeOption(" + si + "," + qi + "," + oi + ")'>x</button></div>";
      }).join("");
      optHTML = "<label>Options:</label>" + opts + "<button class='success' style='font-size:0.8em;padding:4px 10px' onclick='addOption(" + si + "," + qi + ")'>+ Option</button>";
    }
    div.innerHTML = "<div style='display:flex;justify-content:space-between;margin-bottom:8px'><strong>Question " + (qi+1) + "</strong><button class='danger' style='padding:4px 10px' onclick='removeQuestion(" + si + "," + qi + ")'>Supprimer</button></div><label>Type:</label><select onchange='changeType(" + si + "," + qi + ",this.value)'><option " + (q.type==="text"?"selected":"") + ">text</option><option " + (q.type==="number"?"selected":"") + ">number</option><option " + (q.type==="textarea"?"selected":"") + ">textarea</option><option " + (q.type==="radio"?"selected":"") + ">radio</option><option " + (q.type==="checkbox"?"selected":"") + ">checkbox</option><option " + (q.type==="select"?"selected":"") + ">select</option><option " + (q.type==="stars"?"selected":"") + ">stars</option></select><label>Question:</label><input type='text' value='" + q.label.replace(/'/g,"") + "' onchange='questionsData.sections[" + si + "].questions[" + qi + "].label=this.value'>" + optHTML;
    container.appendChild(div);
  });
}

function changeType(si, qi, val) {
  questionsData.sections[si].questions[qi].type = val;
  if ((val === "radio" || val === "checkbox" || val === "select") && !questionsData.sections[si].questions[qi].options) {
    questionsData.sections[si].questions[qi].options = ["Option 1"];
  }
  renderQuestions(si);
}

function addOption(si, qi) {
  if (!questionsData.sections[si].questions[qi].options) questionsData.sections[si].questions[qi].options = [];
  questionsData.sections[si].questions[qi].options.push("Nouvelle option");
  renderQuestions(si);
}

function removeOption(si, qi, oi) {
  questionsData.sections[si].questions[qi].options.splice(oi, 1);
  renderQuestions(si);
}

function addQuestion(si) {
  questionsData.sections[si].questions.push({id: "q_" + Date.now(), type: "text", label: "Nouvelle question", placeholder: ""});
  renderQuestions(si);
}

function removeQuestion(si, qi) {
  if (confirm("Supprimer cette question ?")) {
    questionsData.sections[si].questions.splice(qi, 1);
    renderQuestions(si);
  }
}

function addSection() {
  questionsData.sections.push({id: "s_" + Date.now(), title: "Nouvelle section", questions: []});
  renderEditor();
}

function removeSection(si) {
  if (confirm("Supprimer cette section ?")) {
    questionsData.sections.splice(si, 1);
    renderEditor();
  }
}

function saveQuestions() {
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/save-questions", true);
  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.onload = function() {
    var msg = document.getElementById("msg");
    msg.textContent = "Modifications sauvegardees !";
    msg.className = "msg success";
    msg.style.display = "block";
    setTimeout(function() { msg.style.display = "none"; }, 3000);
  };
  xhr.send(JSON.stringify(questionsData));
}
</script>
</body>
</html>
