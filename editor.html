<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Éditeur de sondage</title>
</head>
<body>

  <h1>Éditeur de sondage</h1>

  <div id="sections-container">
    <!-- Sections will appear here, built by JavaScript -->
  </div>

  <button onclick="addSection()">+ Ajouter une section</button>
  <button onclick="saveQuestions()">✓ Sauvegarder</button>

  <script>

    // Our data — holds all sections and questions in memory
    var data = { sections: [] };

    // RENDER EDITOR — builds the visual editor from data
function renderEditor() {
    var container = document.getElementById("sections-container");
    container.innerHTML = "";

    data.sections.forEach(function(section, si) {
        var questionsHTML = section.questions.map(function(q, qi) {
            var typeOptions = ["text", "textarea", "radio", "stars"].map(function(t) {
                var labels = {text: "Texte court", textarea: "Texte long", radio: "Choix unique", stars: "Étoiles"};
                var sel = q.type === t ? " selected" : "";
                return '<option value="' + t + '"' + sel + '>' + labels[t] + '</option>';
            }).join("");
              
            var optionsHTML = "";
            if (q.type === "radio") {
                optionsHTML = '<div>' +
                  (q.options || []).map(function(opt, oi) {
                      return '<input type="text" value="' + opt + '" ' +
                          'onchange="data.sections[' + si + '].questions[' + qi + '].options[' + oi + '] = this.value">' +
                          '<button onclick="deleteOption(' + si + ',' + qi + ',' + oi + ')">✕</button>';
                  }).join("") +
                  '<button onclick="addOption(' + si + ',' + qi + ')">+ Ajouter une option</button>' +
              '</div>';
          }

            return '<div>' +
                '<input type="text" value="' + q.label + '" ' +
                    'onchange="data.sections[' + si + '].questions[' + qi + '].label = this.value">' +
                '<select onchange="data.sections[' + si + '].questions[' + qi + '].type = this.value">' +
                    typeOptions +
                '</select>' +
                optionsHTML +
                '<button onclick="deleteQuestion(' + si + ',' + qi + ')">✕</button>' +
            '</div>';
        }).join("");

        var div = document.createElement("div");
        div.innerHTML =
            '<h2>' + section.title + '</h2>' +
            '<button onclick="deleteSection(' + si + ')">Supprimer la section</button>' +
            '<div>' + questionsHTML + '</div>' +
            '<button onclick="addQuestion(' + si + ')">+ Ajouter une question</button>';
        container.appendChild(div);
    });
}
    // ADD SECTION — adds a new empty section to data
    function addSection() {
      data.sections.push({
        title: "Nouvelle section",
        questions: []
      });
      renderEditor();
    }

    // DELETE SECTION — removes section at index si
    function deleteSection(si) {
      data.sections.splice(si, 1);
      renderEditor();
    }

    // ADD QUESTION — adds a new empty question to section si
    function addQuestion(si) {
      data.sections[si].questions.push({
        label: "Nouvelle question",
        type: "text",
        options: []
      });
      renderEditor();
    }

    // DELETE QUESTION — removes question qi from section si
    function deleteQuestion(si, qi) {
      data.sections[si].questions.splice(qi, 1);
      renderEditor();
    }

    // SAVE QUESTIONS — sends data to the database
    async function saveQuestions() {
      var res = await fetch("/save-questions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      var json = await res.json();
      if (json.status === "ok") {
        alert("Sauvegardé !");
      } else {
        alert("Erreur lors de la sauvegarde.");
      }
    }

    // LOAD QUESTIONS — fetches existing questions from database on page open
    async function loadQuestions() {
      var res = await fetch("/questions");
      var json = await res.json();
      if (json.sections) {
        data = json;
      }
      renderEditor();
    }

    function addOption(si, qi) {
      data.sections[si].questions[qi].options.push("Nouvelle option");
      renderEditor();
    }
    
    function deleteOption(si, qi, oi) {
      data.sections[si].questions[qi].options.splice(oi, 1);
      renderEditor()
    }

    // Start loading when page opens — always last!
    loadQuestions();

  </script>

</body>
</html>