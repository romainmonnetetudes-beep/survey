<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon espace ‚Äî Sondage Millau</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Lexend:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy: #0f1e2d; --navy-light: #1a2f42;
      --cream: #f5f0e8; --cream-dark: #ede7d9;
      --gold: #c9a84c; --gold-light: #e8c97a;
      --muted: #7a8a96; --white: #ffffff;
      --green: #2d6a4f; --green-light: #e8f4ee;
      --red: #8b2635; --blue: #1a3a5c;
      --shadow: 0 2px 16px rgba(15,30,45,0.08);
      --shadow-md: 0 8px 40px rgba(15,30,45,0.13);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Lexend', sans-serif; background: var(--cream); color: var(--navy); min-height: 100vh; animation: pageIn 0.5s ease forwards; }
    @keyframes pageIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

    /* ===== HERO ===== */
    .hero {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      padding: 48px 10% 56px;
      position: relative;
      overflow: hidden;
      color: white;
    }
    .hero::before {
      content: '';
      position: absolute;
      top: -100px; right: -100px;
      width: 400px; height: 400px;
      border-radius: 50%;
      background: rgba(201,168,76,0.07);
    }
    .hero::after {
      content: '';
      position: absolute;
      bottom: -80px; left: 5%;
      width: 260px; height: 260px;
      border-radius: 50%;
      background: rgba(201,168,76,0.04);
    }

    .hero-inner {
      max-width: 960px;
      margin: 0 auto;
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 40px;
      flex-wrap: wrap;
    }

    /* AVATAR */
    .avatar-wrap {
      position: relative;
      flex-shrink: 0;
    }
    .avatar {
      width: 110px; height: 110px;
      border-radius: 50%;
      background: var(--navy-light);
      border: 4px solid rgba(201,168,76,0.3);
      overflow: hidden;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.2s;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 2.2em;
      color: var(--gold);
    }
    .avatar:hover { border-color: var(--gold); transform: scale(1.04); }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-edit-hint {
      position: absolute;
      bottom: 2px; right: 2px;
      width: 26px; height: 26px;
      background: var(--gold);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7em;
      color: var(--navy);
      border: 2px solid var(--navy);
    }
    #avatarInput { display: none; }

    /* HERO CONTENT */
    .hero-content { flex: 1; min-width: 240px; }
    .hero-greeting {
      font-size: 0.78em;
      color: rgba(245,240,232,0.45);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .hero-name {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.8em, 3vw, 2.4em);
      line-height: 1.1;
      margin-bottom: 6px;
    }
    .hero-name em { color: var(--gold); font-style: italic; font-weight: 400; }
    .hero-username { font-size: 0.78em; color: rgba(245,240,232,0.4); margin-bottom: 14px; }
    .hero-bio {
      font-size: 0.88em;
      color: rgba(245,240,232,0.7);
      line-height: 1.6;
      max-width: 420px;
      margin-bottom: 20px;
      min-height: 20px;
    }
    .hero-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-edit {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.18);
      color: white;
      padding: 9px 18px;
      border-radius: 8px;
      font-family: 'Lexend', sans-serif;
      font-size: 0.82em;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-edit:hover { background: rgba(255,255,255,0.18); }
    .btn-logout {
      background: none;
      border: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.4);
      padding: 9px 18px;
      border-radius: 8px;
      font-family: 'Lexend', sans-serif;
      font-size: 0.82em;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-logout:hover { color: white; border-color: rgba(255,255,255,0.25); }

    /* ===== EDIT PANEL ===== */
    .edit-panel {
      max-width: 960px;
      margin: 0 auto;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
      padding: 0 10%;
    }
    .edit-panel.open {
      max-height: 600px;
      opacity: 1;
      padding: 0 10% 24px;
    }
    .edit-inner {
      background: var(--white);
      border-radius: 0 0 16px 16px;
      padding: 28px 32px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--cream-dark);
      border-top: none;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .edit-inner .full { grid-column: 1 / -1; }
    .edit-label { font-size: 0.72em; color: var(--muted); letter-spacing: 0.06em; margin-bottom: 6px; display: block; }
    .edit-input {
      width: 100%; padding: 10px 14px;
      border: 1.5px solid var(--cream-dark);
      border-radius: 8px;
      font-family: 'Lexend', sans-serif;
      font-size: 0.88em;
      color: var(--navy);
      background: var(--cream);
      outline: none;
      transition: border-color 0.2s, background 0.2s;
    }
    .edit-input:focus { border-color: var(--gold); background: var(--white); }
    textarea.edit-input { resize: vertical; min-height: 72px; }
    .edit-save {
      padding: 10px 24px;
      background: var(--navy);
      color: var(--gold);
      border: none;
      border-radius: 8px;
      font-family: 'Lexend', sans-serif;
      font-size: 0.85em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .edit-save:hover { background: var(--navy-light); transform: translateY(-1px); }

    /* ===== MAIN CONTENT ===== */
    .main {
      max-width: 960px;
      margin: 40px auto;
      padding: 0 10% 80px;
    }

    /* SHARE LINK BOX */
    .link-box {
      background: var(--white);
      border-radius: 14px;
      padding: 22px 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--cream-dark);
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      opacity: 0; transform: translateY(16px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .link-box.visible { opacity: 1; transform: translateY(0); }
    .link-icon { font-size: 1.5em; flex-shrink: 0; }
    .link-info { flex: 1; min-width: 0; }
    .link-title { font-size: 0.85em; font-weight: 500; margin-bottom: 4px; }
    .link-url {
      font-family: monospace;
      font-size: 0.8em;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .link-actions { display: flex; gap: 8px; flex-shrink: 0; }
    .copy-btn {
      padding: 8px 16px;
      background: var(--navy);
      color: var(--cream);
      border: none;
      border-radius: 7px;
      font-family: 'Lexend', sans-serif;
      font-size: 0.78em;
      cursor: pointer;
      transition: all 0.15s;
    }
    .copy-btn:hover { background: var(--navy-light); }
    .copy-msg { font-size: 0.75em; color: var(--green); display: none; align-self: center; }

    /* SECTION LABEL */
    .section-label {
      font-size: 0.65em;
      font-weight: 500;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 14px;
    }

    /* ACTION CARDS */
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; margin-bottom: 40px; }
    .card {
      background: var(--white);
      border-radius: 14px;
      padding: 26px 22px;
      box-shadow: var(--shadow);
      border: 1px solid var(--cream-dark);
      border-top: 3px solid transparent;
      text-decoration: none;
      color: var(--navy);
      display: block;
      transition: transform 0.2s, box-shadow 0.2s;
      opacity: 0; transform: translateY(16px);
    }
    .card.visible { opacity: 1; transform: translateY(0); }
    .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
    .card.blue  { border-top-color: var(--blue); }
    .card.green { border-top-color: var(--green); }
    .card.gold  { border-top-color: var(--gold); }
    .card.red   { border-top-color: var(--red); }
    .card-icon { font-size: 1.8em; margin-bottom: 12px; display: block; }
    .card-tag { font-size: 0.65em; font-weight: 500; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); margin-bottom: 5px; display: block; }
    .card h2 { font-family: 'Playfair Display', serif; font-size: 1.15em; margin-bottom: 7px; }
    .card p { font-size: 0.83em; color: var(--muted); line-height: 1.5; margin-bottom: 14px; }
    .card-arrow { font-size: 0.82em; font-weight: 500; color: var(--blue); transition: transform 0.2s; display: inline-block; }
    .card:hover .card-arrow { transform: translateX(5px); }

    /* TOAST */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 10px; font-size: 0.85em; font-weight: 500; z-index: 1000; display: none; box-shadow: var(--shadow-md); }
    .toast.success { background: var(--navy); color: var(--cream); }
    .toast.error { background: var(--red); color: white; }

    /* LOADING */
    #loading { text-align: center; padding: 80px; color: var(--muted); }
    .spinner { width: 32px; height: 32px; border: 2px solid var(--cream-dark); border-top-color: var(--navy); border-radius: 50%; animation: spin 0.7s linear infinite; margin: 0 auto 14px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 640px) {
      .hero { padding: 36px 6% 44px; }
      .main { padding: 0 6% 60px; }
      .edit-inner { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- HERO -->
  <div class="hero">
    <div class="hero-inner">
      <div class="avatar-wrap">
        <div class="avatar" id="avatar-display" onclick="document.getElementById('avatarInput').click()">
          <span id="avatar-initials">?</span>
        </div>
        <div class="avatar-edit-hint">‚úè</div>
        <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarUpload(this)">
      </div>

      <div class="hero-content">
        <div class="hero-greeting">Bonjour üëã</div>
        <div class="hero-name" id="hero-name">Chargement<em>...</em></div>
        <div class="hero-username" id="hero-username">@...</div>
        <div class="hero-bio" id="hero-bio"></div>
        <div class="hero-actions">
          <button class="btn-edit" onclick="toggleEdit()">‚úè Modifier le profil</button>
          <a href="/logout" class="btn-logout">Se d√©connecter</a>
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT PANEL -->
  <div class="edit-panel" id="edit-panel">
    <div class="edit-inner">
      <div>
        <label class="edit-label">Nom affich√©</label>
        <input type="text" class="edit-input" id="edit-name" placeholder="ex: Romain M." oninput="liveUpdateName(this.value)">
      </div>
      <div>
        <label class="edit-label">Photo de profil</label>
        <input type="text" class="edit-input" id="edit-avatar-url" placeholder="ou collez une URL d'image" oninput="previewAvatarUrl(this.value)">
      </div>
      <div class="full">
        <label class="edit-label">Bio</label>
        <textarea class="edit-input" id="edit-bio" placeholder="Parlez-nous de vous..."></textarea>
      </div>
      <div class="full" style="display:flex;justify-content:flex-end">
        <button class="edit-save" onclick="saveProfile()">‚úì Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="loading" class="main"><div class="spinner"></div>Chargement...</div>

  <div class="main" id="content" style="display:none">

    <!-- SHARE LINK -->
    <div class="link-box" id="link-box">
      <div class="link-icon">üîó</div>
      <div class="link-info">
        <div class="link-title">Lien de votre sondage</div>
        <div class="link-url" id="survey-link">...</div>
      </div>
      <div class="link-actions">
        <button class="copy-btn" onclick="copyLink()">üìã Copier</button>
        <span class="copy-msg" id="copy-msg">‚úì Copi√© !</span>
      </div>
    </div>

    <!-- ACTION CARDS -->
    <div class="section-label">Vos outils</div>
    <div class="cards">
      <a id="card-survey" href="#" class="card blue">
        <span class="card-icon">üìã</span>
        <span class="card-tag">Pr√©visualiser</span>
        <h2>Voir mon sondage</h2>
        <p>Visualisez votre sondage tel que le verront vos r√©pondants.</p>
        <span class="card-arrow">Ouvrir ‚Üí</span>
      </a>
      <a id="card-results" href="#" class="card green">
        <span class="card-icon">üìä</span>
        <span class="card-tag">Statistiques</span>
        <h2>Voir mes r√©sultats</h2>
        <p>Consultez les r√©ponses et analyses de votre sondage.</p>
        <span class="card-arrow">Ouvrir ‚Üí</span>
      </a>
      <a href="/choose" class="card gold">
        <span class="card-icon">‚úèÔ∏è</span>
        <span class="card-tag">Modifier</span>
        <h2>√âditer les questions</h2>
        <p>Ajoutez, modifiez ou supprimez des questions de votre sondage.</p>
        <span class="card-arrow">Ouvrir ‚Üí</span>
      </a>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    var surveyId = null;
    var currentAvatar = "";

    // ===== LOAD =====
    async function loadDashboard() {
      try {
        // Load user/survey info
        var res = await fetch("/me");
        if (res.status === 401) { window.location.href = "/login"; return; }
        var data = await res.json();
        surveyId = data.survey.id;

        // Load profile
        var pRes = await fetch("/get-profile");
        var profile = await pRes.json();

        // Update hero
        var displayName = profile.display_name || data.user.username;
        document.getElementById("hero-name").innerHTML = displayName + ' <em>üëã</em>';
        document.getElementById("hero-username").textContent = "@" + data.user.username;
        document.getElementById("hero-bio").textContent = profile.bio || "";

        // Pre-fill edit form
        document.getElementById("edit-name").value = profile.display_name || "";
        document.getElementById("edit-bio").value = profile.bio || "";
        document.getElementById("edit-avatar-url").value = profile.avatar_url || "";
        currentAvatar = profile.avatar_url || "";

        // Avatar
        updateAvatarDisplay(profile.avatar_url, displayName);

        // Survey link
        var link = window.location.origin + "/survey/" + surveyId;
        document.getElementById("survey-link").textContent = link;
        document.getElementById("card-survey").href = "/survey/" + surveyId;
        document.getElementById("card-results").href = "/resultats/" + surveyId;

        // Show content
        document.getElementById("loading").style.display = "none";
        document.getElementById("content").style.display = "block";

        // Animate
        setTimeout(function() {
          document.querySelectorAll(".card, .link-box").forEach(function(el, i) {
            setTimeout(function() { el.classList.add("visible"); }, i * 100);
          });
        }, 50);

      } catch(e) { window.location.href = "/login"; }
    }

    // ===== AVATAR =====
    function updateAvatarDisplay(url, name) {
      var display = document.getElementById("avatar-display");
      var initials = document.getElementById("avatar-initials");
      if (url && url.length > 0) {
        display.innerHTML = '<img src="' + url + '" onerror="this.parentElement.innerHTML=\'<span id=avatar-initials>' + (name||'?').substring(0,2).toUpperCase() + '</span>\'">';
      } else {
        initials.textContent = (name || '?').substring(0, 2).toUpperCase();
      }
    }

    function handleAvatarUpload(input) {
      var file = input.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { showToast("Image trop grande (max 2MB)", "error"); return; }
      var reader = new FileReader();
      reader.onload = function(e) {
        currentAvatar = e.target.result;
        document.getElementById("edit-avatar-url").value = "";
        updateAvatarDisplay(currentAvatar, document.getElementById("edit-name").value);
      };
      reader.readAsDataURL(file);
    }

    function previewAvatarUrl(url) {
      if (url && url.startsWith("http")) {
        currentAvatar = url;
        updateAvatarDisplay(url, document.getElementById("edit-name").value);
      }
    }

    function liveUpdateName(val) {
      if (val) document.getElementById("hero-name").innerHTML = val + ' <em>üëã</em>';
    }

    // ===== EDIT PANEL =====
    function toggleEdit() {
      document.getElementById("edit-panel").classList.toggle("open");
    }

    // ===== SAVE PROFILE =====
    async function saveProfile() {
      var display_name = document.getElementById("edit-name").value.trim();
      var bio = document.getElementById("edit-bio").value.trim();
      var avatar_url = currentAvatar || document.getElementById("edit-avatar-url").value.trim();

      var res = await fetch("/save-profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ display_name, bio, avatar_url })
      });
      var json = await res.json();
      if (json.status === "ok") {
        document.getElementById("hero-bio").textContent = bio;
        updateAvatarDisplay(avatar_url, display_name || json.username);
        document.getElementById("edit-panel").classList.remove("open");
        showToast("‚úì Profil mis √† jour !", "success");
      } else {
        showToast("Erreur lors de la sauvegarde", "error");
      }
    }

    // ===== COPY LINK =====
    function copyLink() {
      var link = document.getElementById("survey-link").textContent;
      navigator.clipboard.writeText(link).then(function() {
        var msg = document.getElementById("copy-msg");
        msg.style.display = "inline";
        setTimeout(function() { msg.style.display = "none"; }, 2000);
      });
    }

    // ===== TOAST =====
    function showToast(msg, type) {
      var t = document.getElementById("toast");
      t.textContent = msg; t.className = "toast " + type;
      t.style.display = "block";
      setTimeout(function() { t.style.display = "none"; }, 3000);
    }

    loadDashboard();
  </script>
</body>
</html>
