<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©sultats ‚Äî Sondage Millau</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Syne:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy: #0f1e2d; --navy-light: #1a2f42;
      --cream: #f5f0e8; --cream-dark: #ede7d9;
      --gold: #c9a84c; --gold-light: #e8c97a;
      --muted: #7a8a96; --white: #ffffff;
      --green: #2d6a4f; --green-light: #e8f4ee;
      --red: #8b2635; --blue: #1a3a5c;
      --shadow: 0 2px 12px rgba(15,30,45,0.08);
      --shadow-md: 0 8px 32px rgba(15,30,45,0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Syne', sans-serif; background: var(--cream); color: var(--navy); min-height: 100vh; }

    /* HEADER */
    .header {
      background: var(--navy);
      padding: 48px 40px 40px;
      position: relative;
      overflow: hidden;
    }
    .header::before {
      content: ''; position: absolute;
      top: -80px; right: -80px;
      width: 320px; height: 320px;
      border-radius: 50%;
      background: rgba(201,168,76,0.08);
    }
    .header::after {
      content: ''; position: absolute;
      bottom: -60px; left: 10%;
      width: 200px; height: 200px;
      border-radius: 50%;
      background: rgba(201,168,76,0.05);
    }
    .header-inner { max-width: 960px; margin: 0 auto; position: relative; z-index: 1; }
    .header-nav {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 32px;
    }
    .back-link {
      font-size: 0.8em; color: rgba(245,240,232,0.5);
      text-decoration: none; letter-spacing: 0.08em;
      transition: color 0.2s;
    }
    .back-link:hover { color: var(--gold); }
    .refresh-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 16px; border-radius: 20px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(245,240,232,0.7);
      font-family: 'Syne', sans-serif; font-size: 0.78em;
      cursor: pointer; transition: all 0.2s;
    }
    .refresh-btn:hover { background: rgba(255,255,255,0.14); color: var(--cream); }
    .header-tag {
      display: inline-block;
      background: rgba(201,168,76,0.2);
      color: var(--gold);
      font-size: 0.68em; font-weight: 500;
      letter-spacing: 0.18em; text-transform: uppercase;
      padding: 4px 14px; border-radius: 20px;
      margin-bottom: 14px;
    }
    .header h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.8em, 3vw, 2.6em);
      color: var(--cream); line-height: 1.15;
      margin-bottom: 8px;
    }
    .header h1 em { color: var(--gold); font-style: italic; font-weight: 400; }
    .header-sub { color: rgba(245,240,232,0.45); font-size: 0.88em; }

    /* STATS ROW */
    .stats-row {
      display: flex; gap: 0;
      margin-top: 32px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      overflow: hidden;
    }
    .stat-box {
      flex: 1; padding: 18px 24px;
      border-right: 1px solid rgba(255,255,255,0.08);
    }
    .stat-box:last-child { border-right: none; }
    .stat-num {
      font-family: 'Playfair Display', serif;
      font-size: 2em; color: var(--gold);
      line-height: 1; display: block;
    }
    .stat-label { font-size: 0.72em; color: rgba(245,240,232,0.4); margin-top: 4px; letter-spacing: 0.06em; }

    /* MAIN */
    .main { max-width: 960px; margin: 40px auto; padding: 0 24px 80px; }

    /* SECTION HEADER */
    .section-header {
      display: flex; align-items: center; gap: 12px;
      margin: 40px 0 16px;
      opacity: 0; transform: translateY(12px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .section-header.visible { opacity: 1; transform: translateY(0); }
    .section-num {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--navy); color: var(--gold);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.72em; font-weight: 600; flex-shrink: 0;
    }
    .section-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.15em; color: var(--navy);
    }
    .section-divider { flex: 1; height: 1px; background: var(--cream-dark); }

    /* CARD */
    .card {
      background: var(--white); border-radius: 14px;
      padding: 24px; margin-bottom: 14px;
      box-shadow: var(--shadow);
      border: 1px solid var(--cream-dark);
      opacity: 0; transform: translateY(16px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .card.visible { opacity: 1; transform: translateY(0); }
    .card-question {
      font-size: 0.92em; font-weight: 500;
      color: var(--navy); margin-bottom: 20px;
      line-height: 1.5;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--cream-dark);
    }
    .card-type-badge {
      display: inline-block;
      font-size: 0.65em; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--muted);
      background: var(--cream); padding: 2px 8px;
      border-radius: 10px; margin-left: 8px;
      vertical-align: middle; font-weight: 400;
    }
    .no-data { font-size: 0.85em; color: var(--muted); font-style: italic; }

    /* BAR CHART */
    .bar-list { display: flex; flex-direction: column; gap: 10px; }
    .bar-item {}
    .bar-meta {
      display: flex; justify-content: space-between;
      font-size: 0.82em; margin-bottom: 5px;
    }
    .bar-label-text { color: var(--navy); font-weight: 500; }
    .bar-stats { color: var(--muted); font-size: 0.95em; }
    .bar-track {
      height: 8px; background: var(--cream-dark);
      border-radius: 8px; overflow: hidden;
    }
    .bar-fill {
      height: 100%; border-radius: 8px;
      background: linear-gradient(90deg, var(--navy), var(--navy-light));
      width: 0; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .bar-fill.gold { background: linear-gradient(90deg, var(--gold), var(--gold-light)); }
    .bar-fill.green { background: linear-gradient(90deg, var(--green), #52b788); }

    /* STAR RATING */
    .star-display { display: flex; align-items: center; gap: 20px; }
    .star-big {
      font-family: 'Playfair Display', serif;
      font-size: 3em; color: var(--gold); line-height: 1;
    }
    .star-detail {}
    .stars-visual { display: flex; gap: 3px; font-size: 1.4em; margin-bottom: 4px; }
    .star-on { color: var(--gold); }
    .star-off { color: var(--cream-dark); }
    .star-sub { font-size: 0.78em; color: var(--muted); }
    .star-breakdown { margin-top: 16px; display: flex; flex-direction: column; gap: 6px; }
    .star-row { display: flex; align-items: center; gap: 8px; font-size: 0.8em; }
    .star-row-label { width: 40px; color: var(--muted); flex-shrink: 0; }
    .star-row-track { flex: 1; height: 6px; background: var(--cream-dark); border-radius: 6px; overflow: hidden; }
    .star-row-fill { height: 100%; background: var(--gold); border-radius: 6px; width: 0; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .star-row-count { width: 28px; text-align: right; color: var(--muted); flex-shrink: 0; }

    /* VERBATIM */
    .verbatim-list { display: flex; flex-direction: column; gap: 10px; }
    .verbatim {
      background: var(--cream); border-radius: 10px;
      padding: 14px 16px;
      border-left: 3px solid var(--gold);
      font-size: 0.88em; color: var(--navy);
      line-height: 1.6;
      opacity: 0; transform: translateY(8px);
      transition: opacity 0.4s, transform 0.4s;
    }
    .verbatim.visible { opacity: 1; transform: translateY(0); }
    .verbatim-meta { font-size: 0.75em; color: var(--muted); margin-top: 6px; }

    /* EMPTY STATE */
    .empty-state {
      text-align: center; padding: 80px 40px;
      color: var(--muted);
    }
    .empty-state .icon { font-size: 3em; opacity: 0.3; margin-bottom: 16px; }
    .empty-state h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.3em; color: var(--navy);
      margin-bottom: 8px; font-weight: 500;
    }
    .empty-state p { font-size: 0.88em; }

    /* LOADING */
    .loading { text-align: center; padding: 80px; color: var(--muted); }
    .spinner {
      width: 32px; height: 32px;
      border: 2px solid var(--cream-dark);
      border-top-color: var(--navy);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* GRID */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-inner">

      <div class="header-nav">
  <a href="/workspace" class="back-link">‚Üê Mes projets</a>
  <div style="display:flex;gap:8px;align-items:center">
    <select id="survey-selector" onchange="window.location.href='/resultats/'+this.value"
      style="padding:7px 12px;border-radius:20px;background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);color: var(--cream); text-emphasis-color: black;
      font-family:'Syne',sans-serif;font-size:0.78em;outline:none;cursor:pointer;">
      <option value="">Changer de sondage...</option>
    </select>
    <button class="refresh-btn" onclick="loadResults()">‚Üª Actualiser</button>
  </div>
</div>                                    
      <div class="header-tag">R√©sultats</div>
      <h1 id="survey-title">Chargement...</h1>
      <div class="header-sub" id="survey-sub"></div>
      <div class="stats-row">
        <div class="stat-box">
          <span class="stat-num" id="stat-responses">‚Äî</span>
          <div class="stat-label">R√©ponses totales</div>
        </div>
        <div class="stat-box">
          <span class="stat-num" id="stat-questions">‚Äî</span>
          <div class="stat-label">Questions</div>
        </div>
        <div class="stat-box">
          <span class="stat-num" id="stat-last">‚Äî</span>
          <div class="stat-label">Derni√®re r√©ponse</div>
        </div>
        <div class="stat-box">
          <span class="stat-num" id="stat-sections">‚Äî</span>
          <div class="stat-label">Sections</div>
        </div>
      </div>
    </div>
  </div>

  <div class="main" id="main">
    <div class="loading"><div class="spinner"></div>Chargement des r√©sultats...</div>
  </div>

  <script>
    var surveyId = window.location.pathname.split("/").pop();
    var questionsData = null;
    var responsesData = [];

    async function loadResults() {
      document.getElementById("main").innerHTML = '<div class="loading"><div class="spinner"></div>Chargement des r√©sultats...</div>';

      try {
        // Load questions structure
        var qRes = await fetch("/public-questions/" + surveyId);
        questionsData = await qRes.json();

        // Load survey info
        var surveys = [];
        try {
          var sRes = await fetch("/my-surveys");
          surveys = await sRes.json();

          // Populate survey selector
    var selector = document.getElementById("survey-selector");
    surveys.forEach(function(s) {
      var opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.title;
      if (s.id == surveyId) opt.selected = true;
      selector.appendChild(opt);
    });

        } catch(e) {}
        var survey = surveys.find(function(s) { return s.id == surveyId; });

        // Update header
        document.getElementById("survey-title").innerHTML =
          (questionsData.title || survey && survey.title || "Sondage") +
          ' <em>‚Äî r√©sultats</em>';

        // Load responses
        var rRes = await fetch("/results/" + surveyId);
        var raw = await rRes.json();

        responsesData = raw.map(function(r) {
          try { return Object.assign(JSON.parse(r.answer), { _time: r.time }); }
          catch(e) { return null; }
        }).filter(Boolean);

        var n = responsesData.length;
        var sections = questionsData.sections || [];
        var totalQ = sections.reduce(function(acc, s) { return acc + s.questions.length; }, 0);

        // Update stats
        document.getElementById("stat-responses").textContent = n;
        document.getElementById("stat-questions").textContent = totalQ;
        document.getElementById("stat-sections").textContent = sections.length;
        if (n > 0 && responsesData[0]._time) {
          var d = new Date(responsesData[0]._time);
          document.getElementById("stat-last").textContent =
            d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        } else {
          document.getElementById("stat-last").textContent = "‚Äî";
        }

        document.getElementById("survey-sub").textContent =
          n === 0 ? "Aucune r√©ponse pour le moment" :
          n === 1 ? "1 r√©ponse enregistr√©e" : n + " r√©ponses enregistr√©es";

        if (n === 0) {
          document.getElementById("main").innerHTML =
            '<div class="empty-state">' +
              '<div class="icon">üìä</div>' +
              '<h3>Aucune r√©ponse pour le moment</h3>' +
              '<p>Partagez votre sondage pour commencer √† collecter des donn√©es.</p>' +
            '</div>';
          return;
        }

        // Build dashboard
        var html = "";
        sections.forEach(function(section, si) {
          html += '<div class="section-header">' +
            '<div class="section-num">' + (si + 1) + '</div>' +
            '<div class="section-name">' + section.title + '</div>' +
            '<div class="section-divider"></div>' +
          '</div>';

          section.questions.forEach(function(q, qi) {
            var id = "q_" + si + "_" + qi;
            html += buildQuestionCard(q, id, n);
          });
        });

        document.getElementById("main").innerHTML = html;

        // Animate bars
        setTimeout(function() {
          document.querySelectorAll(".bar-fill").forEach(function(b) {
            b.style.width = b.dataset.w;
          });
          document.querySelectorAll(".star-row-fill").forEach(function(b) {
            b.style.width = b.dataset.w;
          });
        }, 100);

        // Scroll animations
        var observer = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry, i) {
            if (entry.isIntersecting) {
              setTimeout(function() { entry.target.classList.add("visible"); }, i * 60);
            }
          });
        }, { threshold: 0.05 });
        document.querySelectorAll(".card, .section-header, .verbatim").forEach(function(el) {
          observer.observe(el);
        });

      } catch(e) {
        document.getElementById("main").innerHTML =
          '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><h3>Erreur de chargement</h3><p>' + e.message + '</p></div>';
      }
    }

    function buildQuestionCard(q, id, n) {
      var typeLabel = { text: "Texte", textarea: "Texte long", radio: "Choix unique", stars: "√âtoiles" }[q.type] || q.type;

      var inner = "";

      if (q.type === "stars") {
        inner = buildStarsCard(q, id, n);
      } else if (q.type === "radio") {
        inner = buildBarCard(q, id, n, "gold");
      } else if (q.type === "text" || q.type === "textarea") {
        inner = buildVerbatimCard(q, id);
      } else {
        inner = buildBarCard(q, id, n, "");
      }

      return '<div class="card">' +
        '<div class="card-question">' + q.label +
          '<span class="card-type-badge">' + typeLabel + '</span>' +
        '</div>' +
        inner +
      '</div>';
    }

    function buildStarsCard(q, id, n) {
      var vals = responsesData.map(function(r) { return parseInt(r[id]); }).filter(function(v) { return v > 0; });
      if (vals.length === 0) return '<div class="no-data">Aucune note pour le moment</div>';

      var avg = (vals.reduce(function(a, b) { return a + b; }, 0) / vals.length).toFixed(1);
      var full = Math.round(avg);

      // Stars visual
      var starsHTML = "";
      for (var i = 1; i <= 5; i++) {
        starsHTML += '<span class="' + (i <= full ? "star-on" : "star-off") + '">‚òÖ</span>';
      }

      // Breakdown by star count
      var counts = [0, 0, 0, 0, 0];
      vals.forEach(function(v) { if (v >= 1 && v <= 5) counts[v - 1]++; });

      var breakdownHTML = '<div class="star-breakdown">';
      for (var s = 5; s >= 1; s--) {
        var c = counts[s - 1];
        var p = n ? Math.round(c / vals.length * 100) : 0;
        breakdownHTML += '<div class="star-row">' +
          '<div class="star-row-label">' + s + ' ‚òÖ</div>' +
          '<div class="star-row-track"><div class="star-row-fill" data-w="' + p + '%" style="width:0"></div></div>' +
          '<div class="star-row-count">' + c + '</div>' +
        '</div>';
      }
      breakdownHTML += '</div>';

      return '<div class="star-display">' +
        '<div class="star-big">' + avg + '</div>' +
        '<div class="star-detail">' +
          '<div class="stars-visual">' + starsHTML + '</div>' +
          '<div class="star-sub">Moyenne sur ' + vals.length + ' r√©ponse' + (vals.length > 1 ? 's' : '') + '</div>' +
        '</div>' +
      '</div>' + breakdownHTML;
    }

    function buildBarCard(q, id, n, colorClass) {
      var counts = {};
      responsesData.forEach(function(r) {
        var v = r[id];
        if (v && v.toString().trim()) {
          counts[v] = (counts[v] || 0) + 1;
        }
      });
      var entries = Object.entries(counts).sort(function(a, b) { return b[1] - a[1]; });
      if (entries.length === 0) return '<div class="no-data">Aucune r√©ponse pour le moment</div>';

      var html = '<div class="bar-list">';
      entries.forEach(function(entry) {
        var label = entry[0], count = entry[1];
        var p = Math.round(count / n * 100);
        html += '<div class="bar-item">' +
          '<div class="bar-meta">' +
            '<span class="bar-label-text">' + label + '</span>' +
            '<span class="bar-stats">' + count + ' r√©ponse' + (count > 1 ? 's' : '') + ' ¬∑ ' + p + '%</span>' +
          '</div>' +
          '<div class="bar-track"><div class="bar-fill ' + colorClass + '" data-w="' + p + '%" style="width:0"></div></div>' +
        '</div>';
      });
      html += '</div>';
      return html;
    }

    function buildVerbatimCard(q, id) {
      var answers = responsesData.map(function(r, i) {
        return { text: r[id], time: r._time };
      }).filter(function(r) { return r.text && r.text.trim().length > 1; });

      if (answers.length === 0) return '<div class="no-data">Aucune r√©ponse textuelle pour le moment</div>';

      var html = '<div class="verbatim-list">';
      answers.slice(0, 20).forEach(function(a) {
        var dateStr = "";
        if (a.time) {
          var d = new Date(a.time);
          dateStr = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        html += '<div class="verbatim">' +
          '"' + a.text + '"' +
          (dateStr ? '<div class="verbatim-meta">' + dateStr + '</div>' : '') +
        '</div>';
      });
      if (answers.length > 20) {
        html += '<div style="font-size:0.8em;color:var(--muted);text-align:center;padding:8px">+ ' + (answers.length - 20) + ' autres r√©ponses</div>';
      }
      html += '</div>';
      return html;
    }

    loadResults();
  </script>
</body>
</html>
